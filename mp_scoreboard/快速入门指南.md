# ğŸš€ Scoreboard å¤„ç†å™¨ - å¿«é€Ÿå…¥é—¨æŒ‡å—

## âœ… å·²ç”Ÿæˆçš„æ‰€æœ‰æ¨¡å—

### ğŸ“¦ æ ¸å¿ƒè®¾è®¡æ–‡ä»¶ (13 ä¸ª SystemVerilog æ¨¡å—)

#### 1. **ç±»å‹å®šä¹‰**
- `pkg/types.sv` - æ‰€æœ‰ç±»å‹å®šä¹‰ï¼ˆFUç±»å‹ã€Scoreboardè¡¨ã€CDBç­‰ï¼‰

#### 2. **é¡¶å±‚æ¨¡å—**
- `hdl/cpu.sv` - CPU é¡¶å±‚ï¼Œé›†æˆæ‰€æœ‰ç»„ä»¶

#### 3. **Scoreboard æ ¸å¿ƒ** (4 ä¸ªæ¨¡å—)
- `hdl/scoreboard/scoreboard.sv` - Scoreboard ä¸»æ§åˆ¶é€»è¾‘ â­â­â­
- `hdl/scoreboard/instruction_queue.sv` - æŒ‡ä»¤é˜Ÿåˆ— (FIFO)
- `hdl/scoreboard/fu_interface.sv` - åŠŸèƒ½å•å…ƒæ¥å£å®šä¹‰
- `hdl/scoreboard/common_data_bus.sv` - CDB ä»²è£å™¨

#### 4. **åŠŸèƒ½å•å…ƒ** (5 ä¸ªæ¨¡å—)
- `hdl/functional_units/fu_alu.sv` - ALU (å•å‘¨æœŸ)
- `hdl/functional_units/fu_multiplier.sv` - ä¹˜æ³•å™¨ (3 å‘¨æœŸ)
- `hdl/functional_units/fu_divider.sv` - é™¤æ³•å™¨ (10 å‘¨æœŸ)
- `hdl/functional_units/fu_load_store.sv` - Load/Store å•å…ƒ
- `hdl/functional_units/fu_branch.sv` - Branch å•å…ƒ

#### 5. **æµæ°´çº¿é˜¶æ®µ** (2 ä¸ªæ¨¡å—)
- `hdl/pipeline/fetch.sv` - å–æŒ‡ä»¤é˜¶æ®µ
- `hdl/regfile.sv` - å¯„å­˜å™¨å †

---

## ğŸ“ ä»£ç ç‰¹ç‚¹

### âœ¨ æ‰€æœ‰ä»£ç éƒ½åŒ…å«è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š

æ¯ä¸ªæ¨¡å—éƒ½æœ‰ï¼š
- ğŸ“– æ¨¡å—åŠŸèƒ½è¯´æ˜
- ğŸ”§ æ¥å£ä¿¡å·è¯´æ˜
- ğŸ’¡ å®ç°é€»è¾‘è¯´æ˜
- ğŸ› è°ƒè¯•æç¤º

### ç¤ºä¾‹ - æ¥è‡ª `scoreboard.sv`ï¼š

```systemverilog
/**
 * ============================================================================
 * Scoreboard ä¸»æ§åˆ¶é€»è¾‘ (Scoreboard Main Control Logic)
 * ============================================================================
 * åŠŸèƒ½ï¼š
 * - ç®¡ç†æ‰€æœ‰åŠŸèƒ½å•å…ƒçš„çŠ¶æ€
 * - æ£€æµ‹å’Œè§£å†³æ•°æ®å†’é™© (RAW, WAW, WAR)
 * - Issue é€»è¾‘ï¼šä»æŒ‡ä»¤é˜Ÿåˆ—å–æŒ‡ä»¤å¹¶åˆ†é…åˆ°ç©ºé—²çš„ FU
 * ...
 */

// Issue é€»è¾‘ (ç»„åˆé€»è¾‘)
always_comb begin
    // éå†æ‰€æœ‰ FUï¼Œæ‰¾åˆ°ç©ºé—²çš„ç›®æ ‡ç±»å‹ FU
    for (int i = 0; i < NUM_FU; i++) begin
        if (fu_status[i].fu_type == required_fu_type &&
            !fu_status[i].busy &&
            fu_if[i].issue_ready) begin
            ...
```

---

## ğŸ—ï¸ æ¶æ„ç†è§£

### 1. **æ•´ä½“æ•°æ®æµ**

```
æŒ‡ä»¤æµå‘:
Fetch â†’ Instruction Queue â†’ Scoreboard (Issue) â†’ FU â†’ CDB â†’ Register File

æ•°æ®ä¾èµ–è¿½è¸ª:
Scoreboard ç»´æŠ¤ä¸¤ä¸ªè¡¨:
  1. FU Status Table (æ¯ä¸ª FU çš„çŠ¶æ€)
  2. Register Result Status (æ¯ä¸ªå¯„å­˜å™¨çš„ç”Ÿäº§è€…)
```

### 2. **å…³é”®ç»„ä»¶äº¤äº’**

#### **Issue é˜¶æ®µ** (åœ¨ `scoreboard.sv`)
```systemverilog
// 1. ä»æŒ‡ä»¤é˜Ÿåˆ—å–æŒ‡ä»¤
if (!iq_empty) {
    // 2. ç¡®å®šéœ€è¦çš„ FU ç±»å‹
    required_fu_type = get_fu_type(opcode);

    // 3. æ‰¾ç©ºé—² FU
    for (int i = 0; i < NUM_FU; i++) {
        if (fu_type == required && !busy && ready) {
            // 4. æ£€æŸ¥ WAW å†’é™©
            if (rd == 0 || !reg_result[rd].pending) {
                // 5. å¯ä»¥ Issueï¼
                can_issue = 1;
            }
        }
    }
}
```

#### **CDB å¹¿æ’­** (åœ¨ `common_data_bus.sv`)
```systemverilog
// å¤šä¸ª FU å®Œæˆæ—¶ï¼Œä»²è£é€‰æ‹©ä¸€ä¸ª
for (int i = 0; i < NUM_FU; i++) {
    if (fu_complete_valid[i]) {
        cdb_data = fu_complete[i];
        cdb_grant[i] = 1;
        break;  // å›ºå®šä¼˜å…ˆçº§
    }
}
```

---

## ğŸ” å¦‚ä½•é˜…è¯»ä»£ç 

### æ¨èé˜…è¯»é¡ºåº

1. **å…ˆè¯»ç±»å‹å®šä¹‰** - `pkg/types.sv`
   - ç†è§£æ•°æ®ç»“æ„ï¼ˆFU status, Register status, CDB entryï¼‰

2. **ç†è§£é¡¶å±‚è¿æ¥** - `hdl/cpu.sv`
   - çœ‹å„æ¨¡å—å¦‚ä½•è¿æ¥
   - æ‰¾åˆ°ä¿¡å·æµå‘

3. **æ·±å…¥ Scoreboard** - `hdl/scoreboard/scoreboard.sv`
   - Issue é€»è¾‘
   - å†’é™©æ£€æµ‹
   - CDB æ›´æ–°

4. **çœ‹åŠŸèƒ½å•å…ƒ** - `hdl/functional_units/fu_alu.sv` (æœ€ç®€å•)
   - ç†è§£ FU æ¥å£
   - Issue â†’ Execute â†’ Complete æµç¨‹

5. **ç†è§£ CDB ä»²è£** - `hdl/scoreboard/common_data_bus.sv`
   - å¦‚ä½•è§£å†³å†™å›å†²çª

---

## ğŸ› ï¸ ä¸‹ä¸€æ­¥å·¥ä½œ

### 1. **éªŒè¯ç¯å¢ƒè®¾ç½®**

éœ€è¦ä» `mp_pipeline` å¤åˆ¶ä»¥ä¸‹æ–‡ä»¶åˆ° `mp_scoreboard/hvl/`:
```bash
cp mp_pipeline/hvl/top_tb.sv mp_scoreboard/hvl/
cp mp_pipeline/hvl/monitor.sv mp_scoreboard/hvl/
cp mp_pipeline/hvl/random_tb.sv mp_scoreboard/hvl/
cp mp_pipeline/hvl/randinst.svh mp_scoreboard/hvl/
cp mp_pipeline/hvl/instr_cg.svh mp_scoreboard/hvl/
cp mp_pipeline/hvl/rvfimon.v mp_scoreboard/hvl/
```

### 2. **åˆ›å»ºç¼–è¯‘è„šæœ¬**

åœ¨ `mp_scoreboard/sim/Makefile`:
```makefile
SRCS = $(wildcard ../pkg/*.sv) \
       $(wildcard ../hdl/*.sv) \
       $(wildcard ../hdl/**/*.sv) \
       $(wildcard ../hvl/*.sv)

compile:
	vcs $(SRCS) -full64 -sverilog +lint=all

run:
	./simv +ntb_random_seed=123
```

### 3. **æµ‹è¯•æ­¥éª¤**

```bash
# 1. ç¼–è¯‘
cd mp_scoreboard/sim
make compile

# 2. è¿è¡Œç®€å•æµ‹è¯•
# ï¼ˆéœ€è¦å…ˆå‡†å¤‡æµ‹è¯•ç¨‹åºï¼‰

# 3. æŸ¥çœ‹æ³¢å½¢
verdi -ssf dump.fsdb
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: ç¼–è¯‘é”™è¯¯ - "æœªå®šä¹‰çš„ç±»å‹"

**åŸå› **: ç±»å‹å®šä¹‰æ–‡ä»¶æœªæ­£ç¡®å¼•å…¥

**è§£å†³**:
```systemverilog
// åœ¨æ¯ä¸ªæ¨¡å—é¡¶éƒ¨æ·»åŠ 
import rv32i_types::*;
```

### Q2: Scoreboard æ­»é”

**ç—‡çŠ¶**: æŒ‡ä»¤å¡åœ¨ Issue é˜¶æ®µ

**æ’æŸ¥**:
1. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ FU éƒ½å¿™ç¢Œ
2. æ£€æŸ¥ RAW ä¾èµ–é“¾
3. æŸ¥çœ‹ Scoreboard çŠ¶æ€è¡¨

**è°ƒè¯•ä»£ç ** (åœ¨ `scoreboard.sv` æ·»åŠ ):
```systemverilog
always @(posedge clk) begin
    if (!can_issue && !iq_empty) begin
        $display("Issue blocked! required_fu=%0d", required_fu_type);
        for (int i = 0; i < NUM_FU; i++) begin
            $display("FU[%0d]: busy=%b type=%0d", i,
                     fu_status[i].busy, fu_status[i].fu_type);
        end
    end
end
```

### Q3: CDB å†²çª

**ç—‡çŠ¶**: å¤šä¸ª FU åŒæ—¶å®Œæˆï¼Œæ•°æ®ä¸¢å¤±

**æ£€æŸ¥**: `common_data_bus.sv` ä¼šè‡ªåŠ¨è­¦å‘Š
```
[CDB] Warning: 3 FUs completed simultaneously
```

**è§£å†³**: è¿™æ˜¯æ­£å¸¸çš„ï¼CDB ä»²è£å™¨ä¼šé€‰æ‹©ä¸€ä¸ªã€‚
å…¶ä»– FU ä¼šåœ¨ä¸‹ä¸ªå‘¨æœŸé‡è¯•ã€‚

---

## ğŸ“Š æ€§èƒ½åˆ†æå·¥å…·

### 1. **CDB åˆ©ç”¨ç‡**

`common_data_bus.sv` è‡ªåŠ¨ç»Ÿè®¡ï¼š
```systemverilog
final begin
    real utilization = (cdb_busy_cycles / total_cycles) * 100.0;
    $display("CDB Utilization: %.2f%%", utilization);
end
```

### 2. **FU åˆ©ç”¨ç‡**

å¯åœ¨ `cpu.sv` æ·»åŠ ï¼š
```systemverilog
// ç»Ÿè®¡æ¯ä¸ª FU çš„å¿™ç¢Œå‘¨æœŸ
logic [31:0] fu_busy_count [TOTAL_FU];

always_ff @(posedge clk) begin
    for (int i = 0; i < TOTAL_FU; i++) begin
        if (fu_if[i].exec_busy) begin
            fu_busy_count[i] <= fu_busy_count[i] + 1;
        end
    end
end
```

### 3. **æŒ‡ä»¤ååé‡ (IPC)**

åœ¨ `top_tb.sv`:
```systemverilog
longint instr_count, cycle_count;
real ipc;

always @(posedge clk) begin
    cycle_count++;
    if (cdb_valid) instr_count++;
end

final begin
    ipc = real'(instr_count) / real'(cycle_count);
    $display("IPC: %.2f", ipc);
end
```

---

## ğŸ“š æ‰©å±•åŠŸèƒ½å»ºè®®

### 1. **æ€§èƒ½ä¼˜åŒ–**

#### A. å¢åŠ  ALU æ•°é‡
```systemverilog
// åœ¨ types.sv ä¿®æ”¹
localparam int NUM_FU_ALU = 4;  // æ”¹ä¸º 4 ä¸ª ALU
```

#### B. æ”¹è¿› CDB ä»²è£
```systemverilog
// åœ¨ common_data_bus.sv ä½¿ç”¨è½®è¯¢
localparam ARBITER_TYPE = 1;  // Round-Robin
```

### 2. **æ·»åŠ æ–°åŠŸèƒ½å•å…ƒ**

ä¾‹å¦‚ï¼Œæ·»åŠ æµ®ç‚¹ FPUï¼š

```systemverilog
// 1. åœ¨ types.sv æ·»åŠ ç±»å‹
typedef enum logic [2:0] {
    FU_ALU_INT = 3'b000,
    ...
    FU_FPU = 3'b110  // æ–°å¢
} fu_type_t;

// 2. åˆ›å»º fu_fpu.sv

// 3. åœ¨ cpu.sv å®ä¾‹åŒ–
fu_fpu fu_fpu_inst (.clk, .rst, .fu_if(fu_if[IDX_FPU]));
```

### 3. **æ·»åŠ åˆ†æ”¯é¢„æµ‹å™¨**

åœ¨ `fetch.sv` æ·»åŠ ç®€å•çš„é™æ€é¢„æµ‹ï¼š
```systemverilog
logic [31:0] predicted_target;

always_comb begin
    // ç®€å•çš„å‘ååˆ†æ”¯é¢„æµ‹ä¸ºè·³è½¬
    if (b_imm[31]) begin  // è´Ÿåç§»
        predicted_target = pc + b_imm;
    end else begin
        predicted_target = pc + 4;
    end
end
```

---

## âœ… éªŒè¯æ£€æŸ¥æ¸…å•

ä½¿ç”¨å‰è¯·ç¡®ä¿ï¼š

- [ ] æ‰€æœ‰ `.sv` æ–‡ä»¶éƒ½æœ‰æ­£ç¡®çš„ `import rv32i_types::*;`
- [ ] `cpu.sv` ä¸­çš„ RVFI ä¿¡å·éƒ½æ­£ç¡®è¿æ¥
- [ ] `rvfi_reference.json` æŒ‡å‘æ­£ç¡®çš„å±‚æ¬¡è·¯å¾„
- [ ] æŒ‡ä»¤é˜Ÿåˆ—æ·±åº¦è¶³å¤Ÿ (å»ºè®® â‰¥ 8)
- [ ] CDB ä»²è£ç­–ç•¥é€‚åˆä½ çš„éœ€æ±‚
- [ ] æ‰€æœ‰ FU éƒ½åœ¨ Scoreboard ä¸­æ­£ç¡®åˆå§‹åŒ–ç±»å‹

---

## ğŸ“ å­¦ä¹ èµ„æº

### æ¨èé˜…è¯»

1. **Scoreboard åŸç†**:
   - æ•™æ: *Computer Architecture: A Quantitative Approach* (Appendix C)
   - Chapter: "Instruction-Level Parallelism"

2. **RISC-V æŒ‡ä»¤é›†**:
   - [RISC-V Spec v2.2](https://riscv.org/specifications/)
   - é‡ç‚¹ï¼šChapter 2 (RV32I)ã€Chapter 19 (æŒ‡ä»¤åˆ—è¡¨)

3. **éªŒè¯æ–¹æ³•å­¦**:
   - RVFI: [riscv-formal](https://github.com/SymbioticEDA/riscv-formal)
   - SystemVerilog Assertions (SVA)

---

## ğŸ’¬ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿è”ç³»ï¼š

**Tsungyu Liu**
- Email: tl152@rice.edu
- GitHub: [@Jasonliuuuu](https://github.com/Jasonliuuuu)

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼Happy Coding! ğŸ‰**
