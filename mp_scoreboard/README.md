# MP_Scoreboard - Scoreboard æ¶æ„å¤„ç†å™¨

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŸºäº **Scoreboard ç®—æ³•**çš„ RISC-V å¤„ç†å™¨ï¼Œæ”¯æŒ**å¤šåŠŸèƒ½å•å…ƒå¹¶è¡Œæ‰§è¡Œ**å’Œ**ä¹±åºå®Œæˆ (Out-of-Order Completion)**ã€‚

### ğŸ¯ è®¾è®¡ç‰¹ç‚¹

- **æ¶æ„**: Scoreboard + å¤šåŠŸèƒ½å•å…ƒ
- **æŒ‡ä»¤é›†**: RV32I (é™¤ FENCE*, ECALL, EBREAK, CSRR* å¤–)
- **å‘å°„**: é¡ºåºå‘å°„ (In-Order Issue)
- **æ‰§è¡Œ**: ä¹±åºæ‰§è¡Œ (Out-of-Order Execution)
- **å®Œæˆ**: ä¹±åºå®Œæˆ (Out-of-Order Completion)
- **åŠŸèƒ½å•å…ƒæ•°é‡**: 6 ä¸ª
  - 2 Ã— ALU (æ•´æ•°è¿ç®—)
  - 1 Ã— ä¹˜æ³•å™¨ (3 å‘¨æœŸå»¶è¿Ÿ)
  - 1 Ã— é™¤æ³•å™¨ (10 å‘¨æœŸå»¶è¿Ÿ)
  - 1 Ã— Load/Store å•å…ƒ
  - 1 Ã— Branch å•å…ƒ

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fetch  â”‚â”€â”€â”€â”€â”€â–¶â”‚ Instruction  â”‚â”€â”€â”€â”€â”€â–¶â”‚ Scoreboard  â”‚
â”‚  Stage  â”‚      â”‚    Queue     â”‚      â”‚   (Issue)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚    Functional Units (6ä¸ª)      â”‚
                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                            â”‚ ALU1 â”‚ ALU2 â”‚ MUL â”‚ DIV â”‚ LS â”‚ BR â”‚
                            â””â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”˜
                                â”‚    â”‚    â”‚   â”‚   â”‚   â”‚
                                â–¼    â–¼    â–¼   â–¼   â–¼   â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   Common Data Bus (CDB)        â”‚
                            â”‚        (ä»²è£å™¨)                 â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Register Fileâ”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scoreboard çŠ¶æ€è¡¨

#### 1. **åŠŸèƒ½å•å…ƒçŠ¶æ€è¡¨** (Functional Unit Status)

| å­—æ®µ | è¯´æ˜ |
|:-----|:-----|
| `busy` | FU æ˜¯å¦å¿™ç¢Œ |
| `op` | æ“ä½œç±»å‹ |
| `fi` | ç›®æ ‡å¯„å­˜å™¨ |
| `fj, fk` | æºå¯„å­˜å™¨ |
| `qj, qk` | æºæ“ä½œæ•°çš„ç”Ÿäº§è€… FU |
| `rj, rk` | æºæ“ä½œæ•°æ˜¯å¦å°±ç»ª |
| `vj, vk` | æºæ“ä½œæ•°çš„å€¼ |

#### 2. **å¯„å­˜å™¨ç»“æœçŠ¶æ€è¡¨** (Register Result Status)

| å­—æ®µ | è¯´æ˜ |
|:-----|:-----|
| `pending` | æ˜¯å¦æœ‰å¾…å†™å…¥ |
| `fu_id` | å“ªä¸ª FU ä¼šå†™å…¥ |

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
mp_scoreboard/
â”œâ”€â”€ hdl/                              # ç¡¬ä»¶æè¿°æ–‡ä»¶
â”‚   â”œâ”€â”€ cpu.sv                        # é¡¶å±‚ CPU æ¨¡å— â­
â”‚   â”œâ”€â”€ regfile.sv                    # å¯„å­˜å™¨å †
â”‚   â”œâ”€â”€ pipeline/
â”‚   â”‚   â””â”€â”€ fetch.sv                  # å–æŒ‡ä»¤é˜¶æ®µ
â”‚   â”œâ”€â”€ scoreboard/                   # Scoreboard æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ scoreboard.sv             # Scoreboard ä¸»æ§åˆ¶é€»è¾‘ â­â­â­
â”‚   â”‚   â”œâ”€â”€ instruction_queue.sv      # æŒ‡ä»¤é˜Ÿåˆ—
â”‚   â”‚   â”œâ”€â”€ fu_interface.sv           # åŠŸèƒ½å•å…ƒæ¥å£å®šä¹‰
â”‚   â”‚   â””â”€â”€ common_data_bus.sv        # CDB ä»²è£å™¨
â”‚   â””â”€â”€ functional_units/             # åŠŸèƒ½å•å…ƒå®ç°
â”‚       â”œâ”€â”€ fu_alu.sv                 # ALU åŠŸèƒ½å•å…ƒ
â”‚       â”œâ”€â”€ fu_multiplier.sv          # ä¹˜æ³•å™¨åŠŸèƒ½å•å…ƒ
â”‚       â”œâ”€â”€ fu_divider.sv             # é™¤æ³•å™¨åŠŸèƒ½å•å…ƒ
â”‚       â”œâ”€â”€ fu_load_store.sv          # Load/Store åŠŸèƒ½å•å…ƒ
â”‚       â””â”€â”€ fu_branch.sv              # Branch åŠŸèƒ½å•å…ƒ
â”œâ”€â”€ pkg/
â”‚   â””â”€â”€ types.sv                      # ç±»å‹å®šä¹‰ â­
â”œâ”€â”€ hvl/                              # éªŒè¯ç¯å¢ƒ
â”‚   â”œâ”€â”€ top_tb.sv                     # é¡¶å±‚æµ‹è¯•å¹³å°
â”‚   â”œâ”€â”€ rvfi_reference.json           # RVFI è¿æ¥é…ç½®
â”‚   â”œâ”€â”€ monitor.sv                    # RVFI ç›‘è§†å™¨
â”‚   â”œâ”€â”€ random_tb.sv                  # éšæœºæµ‹è¯•
â”‚   â”œâ”€â”€ randinst.svh                  # éšæœºæŒ‡ä»¤ç”Ÿæˆ
â”‚   â””â”€â”€ instr_cg.svh                  # åŠŸèƒ½è¦†ç›–ç‡
â”œâ”€â”€ sim/                              # ä»¿çœŸè„šæœ¬
â”œâ”€â”€ synth/                            # ç»¼åˆè„šæœ¬
â””â”€â”€ README.md                         # æœ¬æ–‡æ¡£

â­ = æ ¸å¿ƒæ¨¡å—
```

---

## ğŸ”§ Scoreboard ç®—æ³•æµç¨‹

### å››ä¸ªé˜¶æ®µ

#### 1. **Issue (å‘å°„)**
```
æ£€æŸ¥ï¼š
  âœ“ æ˜¯å¦æœ‰ç©ºé—²çš„å¯¹åº”ç±»å‹ FUï¼Ÿ
  âœ“ æ˜¯å¦å­˜åœ¨ WAW å†’é™©ï¼Ÿ
æ“ä½œï¼š
  - åˆ†é… FU
  - æ›´æ–°å¯„å­˜å™¨ç»“æœçŠ¶æ€è¡¨
  - æ£€æŸ¥æ“ä½œæ•°ä¾èµ– (RAW)
```

#### 2. **Read Operands (è¯»æ“ä½œæ•°)**
```
æ£€æŸ¥ï¼š
  âœ“ Rj å’Œ Rk æ˜¯å¦éƒ½å°±ç»ªï¼Ÿ
æ“ä½œï¼š
  - å¦‚æœå°±ç»ªï¼šä»å¯„å­˜å™¨å †è¯»å–
  - å¦‚æœæœªå°±ç»ªï¼šè®°å½•ç”Ÿäº§è€… FU (Qj/Qk)
  - ç­‰å¾… CDB å¹¿æ’­
```

#### 3. **Execution (æ‰§è¡Œ)**
```
- åœ¨åŠŸèƒ½å•å…ƒå†…éƒ¨æ‰§è¡Œ
- ä¸åŒ FU å»¶è¿Ÿä¸åŒï¼š
  * ALU: 1 cycle
  * MUL: 3 cycles
  * DIV: 10 cycles
  * Load/Store: å¯å˜ (å–å†³äºå†…å­˜å“åº”)
  * Branch: 1 cycle
```

#### 4. **Write Result (å†™å›)**
```
æ“ä½œï¼š
  - é€šè¿‡ CDB å¹¿æ’­ç»“æœ
  - æ›´æ–°ç­‰å¾…è¯¥ç»“æœçš„ FU (Vj/Vk)
  - æ¸…é™¤å¯„å­˜å™¨ç»“æœçŠ¶æ€
  - å†™å…¥å¯„å­˜å™¨å †
```

---

## ğŸš€ ä½¿ç”¨è¯´æ˜

### ç¯å¢ƒè¦æ±‚

- Synopsys VCS (ä»¿çœŸ)
- Verdi (æ³¢å½¢æŸ¥çœ‹)
- Python 3.x (è„šæœ¬å·¥å…·)

### ç¼–è¯‘å’Œè¿è¡Œ

```bash
# è¿›å…¥ä»¿çœŸç›®å½•
cd mp_scoreboard/sim

# ç¼–è¯‘è®¾è®¡
make compile

# è¿è¡Œéšæœºæµ‹è¯•
make run_random

# æŸ¥çœ‹æ³¢å½¢
make verdi

# æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š
make covrep
```

---

## ğŸ“Š å…³é”®è®¾è®¡å†³ç­–

### 1. **ä¸ºä»€ä¹ˆé€‰æ‹© Scoreboard è€Œä¸æ˜¯ Tomasuloï¼Ÿ**

| ç‰¹æ€§ | Scoreboard | Tomasulo |
|:-----|:-----------|:---------|
| **å¤æ‚åº¦** | è¾ƒä½ | è¾ƒé«˜ |
| **ç¡¬ä»¶å¼€é”€** | è¾ƒå° | è¾ƒå¤§ (éœ€è¦ ROB + Rename) |
| **WAW/WAR å¤„ç†** | åœé¡¿ | å¯„å­˜å™¨é‡å‘½å |
| **æ€§èƒ½** | ä¸­ç­‰ | æ›´é«˜ |

**é€‰æ‹© Scoreboard çš„åŸå› **:
- æ›´å®¹æ˜“ç†è§£å’Œå®ç°
- ç¡¬ä»¶å¼€é”€è¾ƒå°
- å¯¹äºæ•™å­¦å’ŒåŸå‹éªŒè¯è¶³å¤Ÿ

### 2. **åŠŸèƒ½å•å…ƒé…ç½®**

- **2 ä¸ª ALU**: æé«˜æ•´æ•°è¿ç®—ååé‡ï¼ˆå¤§éƒ¨åˆ†æŒ‡ä»¤æ˜¯ ALU æ“ä½œï¼‰
- **1 ä¸ªä¹˜æ³•å™¨**: å¹³è¡¡æ€§èƒ½å’Œé¢ç§¯
- **1 ä¸ªé™¤æ³•å™¨**: é™¤æ³•æ“ä½œè¾ƒå°‘ï¼Œ1 ä¸ªè¶³å¤Ÿ
- **1 ä¸ª Load/Store**: é™åˆ¶å¹¶å‘å†…å­˜è®¿é—®ï¼ˆç®€åŒ–å†…å­˜ä¸€è‡´æ€§ï¼‰
- **1 ä¸ª Branch**: åˆ†æ”¯æ“ä½œéœ€è¦ç«‹å³è§£æä»¥å‡å°‘ Flush

### 3. **CDB ä»²è£ç­–ç•¥**

ç›®å‰ä½¿ç”¨**å›ºå®šä¼˜å…ˆçº§**ï¼š
```
ALU > MUL > DIV > Load/Store > Branch
```

**ä¼˜ç‚¹**: ç®€å•ï¼Œç¡®å®šæ€§
**ç¼ºç‚¹**: å¯èƒ½å¯¼è‡´ä½ä¼˜å…ˆçº§ FU é¥¥é¥¿

å¯æ”¹ä¸º**è½®è¯¢ (Round-Robin)** ä»¥æé«˜å…¬å¹³æ€§ã€‚

---

## ğŸ› è°ƒè¯•æŠ€å·§

### 1. **ä½¿ç”¨ Scoreboard çŠ¶æ€ç›‘æ§**

åœ¨ `scoreboard.sv` ä¸­æœ‰è°ƒè¯•è¾“å‡ºï¼ˆéœ€å®šä¹‰ `DEBUG_SCOREBOARD`ï¼‰ï¼š

```systemverilog
`define DEBUG_SCOREBOARD

// æ¯ä¸ªå‘¨æœŸæ‰“å° Scoreboard çŠ¶æ€
```

### 2. **CDB å†²çªæ£€æµ‹**

`common_data_bus.sv` è‡ªåŠ¨æ£€æµ‹å¤šä¸ª FU åŒæ—¶å®Œæˆçš„æƒ…å†µï¼š

```
[CDB] Warning: 3 FUs completed simultaneously at time 12345
```

### 3. **RVFI éªŒè¯**

RVFI ä¼šè‡ªåŠ¨æ£€æµ‹ï¼š
- PC é”™è¯¯ (Shadow PC error)
- å¯„å­˜å™¨å€¼é”™è¯¯ (RD error)
- æºå¯„å­˜å™¨é”™è¯¯ (Shadow RS1/RS2 error)

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### ç†è®º IPC (Instructions Per Cycle)

- **ç†æƒ³æƒ…å†µ**: IPC â‰ˆ 6 (6 ä¸ª FU å¹¶è¡Œ)
- **å®é™…æƒ…å†µ**: IPC â‰ˆ 1.5 ~ 2.5
  - å—é™äºæ•°æ®ä¾èµ–
  - å—é™äº CDB å¸¦å®½ (å•å‘¨æœŸåªèƒ½å†™å› 1 ä¸ªç»“æœ)
  - å—é™äºç»“æ„å†’é™© (FU å ç”¨)

### CDB åˆ©ç”¨ç‡

`common_data_bus.sv` ä¼šè‡ªåŠ¨ç»Ÿè®¡ CDB åˆ©ç”¨ç‡ï¼š

```
CDB Utilization Statistics:
  Total Cycles: 10000
  CDB Busy Cycles: 6543
  Utilization: 65.43%
```

---

## âœ… éªŒè¯ç­–ç•¥

1. **çº¦æŸéšæœºæµ‹è¯•** (`random_tb.sv`)
   - ç”Ÿæˆ 60,000 æ¡éšæœº RV32I æŒ‡ä»¤
   - è‡ªåŠ¨æ£€æµ‹åŠŸèƒ½é”™è¯¯

2. **RVFI å½¢å¼åŒ–éªŒè¯** (`rvfimon.v`)
   - å®æ—¶æ£€æŸ¥æ¯æ¡æŒ‡ä»¤çš„æ‰§è¡Œç»“æœ
   - å¯¹æ¯”é»„é‡‘æ¨¡å‹

3. **åŠŸèƒ½è¦†ç›–ç‡** (`instr_cg.svh`)
   - ç›®æ ‡ï¼š98%+ è¦†ç›–ç‡
   - è¦†ç›–æ‰€æœ‰æŒ‡ä»¤ç±»å‹å’Œå¯„å­˜å™¨ç»„åˆ

4. **ä¹±åºå®Œæˆè¿½è¸ª**
   - ç›‘æ§æŒ‡ä»¤åºå· (`order`)
   - ç¡®ä¿ä¹±åºå®Œæˆä¸å½±å“æ­£ç¡®æ€§

---

## ğŸ“ å¾…åŠäº‹é¡¹ (TODO)

- [ ] æ·»åŠ æ€§èƒ½è®¡æ•°å™¨ (Performance Counters)
- [ ] å®ç° Load/Store é˜Ÿåˆ— (LSQ) ä»¥æ”¯æŒå¤šä¸ªå¹¶å‘å†…å­˜è®¿é—®
- [ ] æ”¯æŒ M æ‰©å±•çš„å®Œæ•´å®ç° (å½“å‰ä»…æ”¯æŒåŸºç¡€ MUL/DIV)
- [ ] æ·»åŠ åˆ†æ”¯é¢„æµ‹å™¨ (Branch Predictor)
- [ ] å®ç°å¯„å­˜å™¨é‡å‘½åä»¥æ¶ˆé™¤ WAW/WAR åœé¡¿

---

## ğŸ¤ è´¡çŒ®è€…

**Tsungyu Liu**
Rice University Â· Master of ECE
Email: tl152@rice.edu
GitHub: [@Jasonliuuuu](https://github.com/Jasonliuuuu)

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **Scoreboard ç®—æ³•åŸè®ºæ–‡**:
   - "Parallel Operation in the Control Data 6600" - J. E. Thornton (1964)

2. **RISC-V è§„èŒƒ**:
   - [RISC-V ISA Specification v2.2](https://riscv.org/specifications/)

3. **RVFI éªŒè¯æ¥å£**:
   - [RISC-V Formal Interface](https://github.com/SymbioticEDA/riscv-formal)

4. **å‚è€ƒæ•™æ**:
   - *Computer Architecture: A Quantitative Approach* - Hennessy & Patterson
   - Chapter 3: Instruction-Level Parallelism

---

## ğŸ“„ License

æœ¬é¡¹ç›®ç”¨äºæ•™è‚²ç›®çš„ã€‚è¯·éµå®ˆæ‚¨æ‰€åœ¨æœºæ„çš„å­¦æœ¯è¯šä¿¡æ”¿ç­–ã€‚

---

**Happy Hacking! ğŸš€**
